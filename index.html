<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高鐵時刻表 - 最終完美版</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #ff6600;
            --danger: #d63031;
            --bg-color: #f8f9fa;
            --text-dark: #2d3436;
            --border-color: #dfe6e9;
            --bubble-size: 42px;
            --tv-bg: #0f0f0f;
            --tv-header-north: #0056b3;
            --tv-header-south: #1e7e34;
            --tv-row-bg: #1a1a1a;
            --tv-text-white: #e0e0e0;
            --tv-text-yellow: #ffc107;
            --tv-dot-off: #444;
            --tv-line: #555;
            --tv-dot-north: #3498db;
            --tv-dot-south: #2ecc71;
            --highlight-light: rgba(255, 102, 0, 0.08);
            --highlight-tv: rgba(255, 193, 7, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); }

        .app-container { height: 100%; max-width: 600px; margin: 0 auto; background: white; display: flex; flex-direction: column; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .app-header { padding: 15px; text-align: center; border-bottom: 1px solid var(--border-color); background: white; z-index: 10; }
        .app-header h1 { margin: 0; font-size: 1.2rem; color: var(--text-dark); display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scrollbar-width: none; }
        .app-content::-webkit-scrollbar { display: none; }
        .app-footer { padding: 15px; border-top: 1px solid var(--border-color); background: white; z-index: 10; }

        .section-title { font-size: 0.9rem; color: #636e72; margin-bottom: 8px; font-weight: 500; }
        .station-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .station-bubble { background: #f1f2f6; color: var(--text-dark); height: var(--bubble-size); display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; user-select: none; border: 1px solid transparent; }
        .station-bubble.active { background: var(--primary); color: white; font-weight: bold; }
        
        .swap-wrapper { display: flex; justify-content: center; margin: -5px 0; position: relative; z-index: 5; }
        .swap-btn { background: white; border: 1px solid var(--border-color); color: var(--primary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        
        input.flatpickr-input, select { 
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; 
            background: #f8f9fa; font-size: 1rem; outline: none; color: #333;
        }

        .btn-now { background: #eee; border: 1px solid var(--border-color); color: #555; padding: 0 15px; border-radius: 10px; font-size: 0.85rem; cursor: pointer; white-space: nowrap; font-weight: 500; }
        .btn-submit { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-active { display: flex; }
        .modal-card { background: white; width: 98%; max-width: 800px; border-radius: 12px; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        #view-list { flex: 1; overflow-y: auto; padding: 15px; }
        .result-card { border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; padding: 15px; background: white; cursor: pointer; transition: 0.2s; }
        .result-card.selected { background: var(--highlight-light); border-color: var(--primary); }

        .train-id-pill { background: #fff5f0; color: var(--primary); padding: 4px 8px; border-radius: 6px; font-weight: bold; font-family: 'Roboto'; font-size: 0.9rem; }
        .train-duration { font-size: 0.85rem; color: #888; margin-left: 8px; font-weight: 500; }
        .train-times { font-size: 1.2rem; font-weight: bold; color: var(--text-dark); }
        
        .card-footer { margin-top: 10px; font-size: 0.85rem; color: #666; display: flex; align-items: center; overflow: hidden; }
        .tag-base { padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 8px; font-weight: 500; white-space: nowrap; flex-shrink: 0; }
        .tag-stop { background: #eee; color: #666; }
        .tag-direct { background: var(--danger); color: white; }

        .stops-scroll { 
            white-space: nowrap; 
            overflow-x: auto; 
            scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
            color: #555;
            flex: 1;
        }
        .stops-scroll::-webkit-scrollbar { display: none; }
        .stop-sep { color: #ddd; margin: 0 5px; font-weight: bold; }

        #view-tv { flex: 1; display: none; flex-direction: column; overflow: hidden; background: var(--tv-bg); }
        #view-tv.active { display: flex; }
        .tv-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tv-header-bar { padding: 10px 15px; color: white; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .tv-header-bar.theme-north { background: var(--tv-header-north); border-bottom: 3px solid #0099ff; }
        .tv-header-bar.theme-south { background: var(--tv-header-south); border-bottom: 3px solid #2ecc71; }
        
        .tv-scroll-area { flex: 1; overflow-y: auto; }
        
        .tv-row { display: grid; grid-template-columns: 240px 1fr; border-bottom: 1px solid #333; background: var(--tv-row-bg); min-height: 85px; cursor: pointer; }
        .tv-row.selected { background: var(--highlight-tv); }

        .tv-info-col { padding: 15px; display: grid; grid-template-columns: 70px 1fr 70px; align-items: center; border-right: 1px solid #333; gap: 5px; }
        .tv-time { color: var(--tv-text-yellow); font-weight: bold; font-size: 1.2rem; text-align: right; }
        
        .tv-map-col { position: relative; display: flex; align-items: center; padding: 10px 5px; overflow: hidden; }
        .map-container { display: flex; justify-content: space-between; width: 100%; min-width: auto; position: relative; padding: 10px 0 15px 0; }
        .map-line { position: absolute; top: 60px; left: 0; right: 0; height: 2px; background: var(--tv-line); }
        
        .station-point { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; flex: 1; }
        .st-name { font-size: 0.65rem; color: #888; writing-mode: vertical-rl; height: 42px; margin-bottom: 4px; letter-spacing: -1px; }
        .st-name.current { color: var(--tv-text-yellow); font-weight: bold; font-size: 0.75rem; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--tv-dot-off); }
        .dot.stop { border: 1px solid #fff; }
        .theme-north .dot.stop { background: var(--tv-dot-north); box-shadow: 0 0 6px var(--tv-dot-north); }
        .theme-south .dot.stop { background: var(--tv-dot-south); box-shadow: 0 0 6px var(--tv-dot-south); }

        .toggle-btn { background: #eee; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .toggle-btn.active { background: var(--primary); color: white; }
        .share-btn { background: #00b894; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; }

        @media (max-width: 650px) {
            .tv-row { grid-template-columns: 1fr; min-height: auto; }
            .tv-info-col { border-right: none; border-bottom: 1px solid #333; padding: 10px 15px; }
            .tv-map-col { padding: 15px 10px 20px 10px; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h1><i class="fas fa-train-subway" style="color:var(--primary)"></i> 高鐵時刻表</h1>
    </div>
    <div class="app-content">
        <div>
            <div class="section-title">出發站</div>
            <div class="station-grid" id="startGrid"></div>
        </div>
        <div class="swap-wrapper">
            <div class="swap-btn" onclick="swapStations()"><i class="fas fa-exchange-alt" style="transform: rotate(90deg);"></i></div>
        </div>
        <div>
            <div class="section-title">抵達站</div>
            <div class="station-grid" id="endGrid"></div>
        </div>
        <div style="display:flex; gap:10px;">
            <div style="flex:2; display:flex; gap:8px;">
                <input type="text" id="query_time">
                <button type="button" class="btn-now" onclick="setCurrentTime()">現在</button>
            </div>
            <div style="flex:1">
                <select id="limit">
                    <option value="5">5筆</option>
                    <option value="10">10筆</option>
                    <option value="-1">全部</option>
                </select>
            </div>
        </div>
    </div>
    <div class="app-footer">
        <button id="searchBtn" class="btn-submit" onclick="fetchSchedule()">查詢班次</button>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div style="display:flex; gap:8px;">
                <button class="toggle-btn active" id="btn-list" onclick="switchView('list')">列表</button>
                <button class="toggle-btn" id="btn-tv" onclick="switchView('tv')">電視牆</button>
                <button class="share-btn" id="shareBtn" onclick="shareAsImage()"><i class="fas fa-share-nodes"></i> 分享畫面</button>
            </div>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.8rem; cursor:pointer;">&times;</button>
        </div>
        <div class="modal-body" id="capture-area">
            <div id="view-list"></div>
            <div id="view-tv">
                <div class="tv-wrapper">
                    <div id="tv-header" class="tv-header-bar"></div>
                    <div id="tv-rows" class="tv-scroll-area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "/api/thsr";
    const TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjZXJ0IjoiOTczOTIyYjg1OTkxZTE3ZDUyZGU0MDE1ZmIzNjU5ZmIzM2M4ODkzOSIsImlhdCI6MTc2Njk4ODQ2OX0.G9SVSfeuon2Rf7iSLmKfzEAXLK_DVz3ZsPQeB1xzSRc";
    const stations = { 1: "南港", 2: "台北", 3: "板橋", 4: "桃園", 5: "新竹", 6: "苗栗", 7: "台中", 8: "彰化", 9: "雲林", 10: "嘉義", 11: "台南", 12: "左營" };
    let currentStart = 0, currentEnd = 0, fp, currentView = 'list';

    function init() {
        const renderGrid = (id, type) => {
            const el = document.getElementById(id);
            Object.entries(stations).forEach(([sid, name]) => {
                const b = document.createElement('div');
                b.className = 'station-bubble';
                b.textContent = name;
                b.dataset.id = sid;
                b.onclick = () => {
                    if (type === 'start') { currentStart = parseInt(sid); if(currentEnd === currentStart) currentEnd = 0; }
                    else { currentEnd = parseInt(sid); if(currentStart === currentEnd) currentStart = 0; }
                    updateUI();
                };
                el.appendChild(b);
            });
        };
        renderGrid('startGrid', 'start');
        renderGrid('endGrid', 'end');
        fp = flatpickr("#query_time", { enableTime: true, dateFormat: "Y-m-d H:i", locale: "zh_tw", defaultDate: new Date(), time_24hr: true, disableMobile: "true" });
    }

    function updateUI() {
        document.querySelectorAll('#startGrid .station-bubble').forEach(b => b.classList.toggle('active', parseInt(b.dataset.id) === currentStart));
        document.querySelectorAll('#endGrid .station-bubble').forEach(b => b.classList.toggle('active', parseInt(b.dataset.id) === currentEnd));
    }

    function swapStations() { [currentStart, currentEnd] = [currentEnd, currentStart]; updateUI(); }
    function setCurrentTime() { fp.setDate(new Date()); }

    function calcDuration(dep, arr) {
        if(!dep || !arr) return "-";
        const [dh, dm] = dep.split(':').map(Number);
        const [ah, am] = arr.split(':').map(Number);
        let diff = (ah * 60 + am) - (dh * 60 + dm);
        if(diff < 0) diff += 24 * 60;
        const h = Math.floor(diff / 60);
        const m = diff % 60;
        return h > 0 ? `${h}小時${m}分` : `${m}分`;
    }

    async function fetchSchedule() {
        if (!currentStart || !currentEnd) return alert("請選擇起訖站");
        const btn = document.getElementById('searchBtn');
        btn.disabled = true;
        btn.innerHTML = '查詢中...';
        try {
            const qVal = document.getElementById('query_time').value;
            const isoTime = qVal.replace(' ', 'T') + ':00Z'; 

            const response = await axios.post(API_URL, { start_station_no: currentStart, end_station_no: currentEnd, datetime: isoTime }, { headers: { 'token': TOKEN } });
            switchView('list');
            renderResults(response.data);
            document.getElementById('resultModal').classList.add('modal-active');
        } catch (e) { alert("連線失敗"); } finally { btn.disabled = false; btn.textContent = "查詢班次"; }
    }

    function renderResults(data) {
        const trains = data.train_item || data.data || [];
        const list = document.getElementById('view-list');
        const tv = document.getElementById('tv-rows');
        const limit = parseInt(document.getElementById('limit').value);
        list.innerHTML = ''; tv.innerHTML = '';
        const isSouth = currentStart < currentEnd;
        const theme = isSouth ? 'theme-south' : 'theme-north';
        document.getElementById('tv-header').className = `tv-header-bar ${theme}`;
        document.getElementById('tv-header').innerHTML = `<span>${isSouth ? '南下' : '北上'}</span><span style="font-size:0.8rem;">${new Date().toLocaleTimeString()} UPDATED</span>`;
        const sortedKeys = Object.keys(stations).map(Number).sort((a,b) => isSouth ? a-b : b-a);

        trains.slice(0, limit === -1 ? trains.length : limit).forEach((t, index) => {
            const actualStops = (t.station_info || []).filter(s => s.departure_time && s.departure_time !== "--:--");
            const stopIds = actualStops.map(s => parseInt(s.station_no));
            const stopNames = actualStops.filter(s => { const id = parseInt(s.station_no); return isSouth ? (id > currentStart && id < currentEnd) : (id < currentStart && id > currentEnd); }).map(s => s.name);
            const isDirect = stopNames.length === 0;

            // --- 修正：優先使用 API 的 duration 欄位，若無則計算 ---
            const durationText = t.duration || calcDuration(t.departure_time, t.destination_time || t.arrival_time);

            const card = document.createElement('div');
            card.className = 'result-card';
            card.onclick = () => card.classList.toggle('selected');
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="display:flex; align-items:center;">
                        <span class="train-id-pill">${t.id || t.train_no}</span>
                        <span class="train-duration">${durationText}</span>
                    </div>
                    <div class="train-times">${t.departure_time} ➝ ${t.destination_time || t.arrival_time}</div>
                </div>
                <div class="card-footer">
                    ${isDirect ? '<span class="tag-base tag-direct">直達</span>' : '<span class="tag-base tag-stop">停靠</span>'}
                    <div class="stops-scroll">
                        ${stopNames.join('<span class="stop-sep">•</span>')}
                    </div>
                </div>`;
            list.appendChild(card);

            const row = document.createElement('div');
            row.className = 'tv-row';
            row.onclick = () => row.classList.toggle('selected');
            let mapNodes = '';
            sortedKeys.forEach(sid => {
                const isStop = stopIds.includes(sid);
                mapNodes += `<div class="station-point">
                    <div class="st-name ${sid === currentStart || sid === currentEnd ? 'current' : ''}">${stations[sid].substring(0,2)}</div>
                    <div class="dot ${isStop ? 'stop' : ''}"></div>
                    </div>`;
            });
            row.innerHTML = `<div class="tv-info-col">
                <div style="color:white;">${t.id || t.train_no}</div>
                <div style="color:white; font-size:0.9rem; white-space:nowrap;">${stations[currentStart]}➝${stations[currentEnd]}</div>
                <div class="tv-time">${t.departure_time}</div>
                </div>
                <div class="tv-map-col ${theme}"><div class="map-container"><div class="map-line"></div>${mapNodes}</div></div>`;
            tv.appendChild(row);
        });
    }

    function switchView(m) {
        currentView = m;
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+m).classList.add('active');
        document.getElementById('view-list').style.display = m === 'list' ? 'block' : 'none';
        document.getElementById('view-tv').classList.toggle('active', m === 'tv');
        document.getElementById('capture-area').style.background = m === 'tv' ? '#0f0f0f' : 'white';
    }

    function closeModal() { document.getElementById('resultModal').classList.remove('modal-active'); }

    async function shareAsImage() {
        const btn = document.getElementById('shareBtn');
        const container = document.getElementById(currentView === 'list' ? 'view-list' : 'tv-rows');
        const selectedItems = container.querySelectorAll('.selected');
        
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 處理中...';
        
        const tempContainer = document.createElement('div');
        tempContainer.style.background = (currentView === 'tv') ? '#0f0f0f' : 'white';
        tempContainer.style.width = container.offsetWidth + 'px';
        tempContainer.style.padding = '20px';
        
        if (selectedItems.length > 0) {
            if (currentView === 'tv') tempContainer.appendChild(document.getElementById('tv-header').cloneNode(true));
            selectedItems.forEach(item => {
                const clone = item.cloneNode(true);
                clone.classList.remove('selected');
                tempContainer.appendChild(clone);
            });
        } else {
            if (currentView === 'tv') tempContainer.appendChild(document.getElementById('tv-header').cloneNode(true));
            const contentClone = container.cloneNode(true);
            tempContainer.appendChild(contentClone);
        }

        document.body.appendChild(tempContainer);
        tempContainer.style.position = 'absolute';
        tempContainer.style.top = '-9999px';
        tempContainer.style.left = '-9999px';

        try {
            const canvas = await html2canvas(tempContainer, { 
                backgroundColor: getComputedStyle(tempContainer).backgroundColor, 
                scale: 2, 
                useCORS: true
            });

            const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
            const file = new File([blob], 'THSR_Schedule.png', { type: 'image/png' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: '高鐵時刻表',
                    text: '這是我選好的班次'
                });
            } else {
                const link = document.createElement('a');
                link.download = `THSR_${Date.now()}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        } catch (e) {
            console.error(e);
            alert("操作失敗");
        } finally {
            document.body.removeChild(tempContainer);
            btn.innerHTML = '<i class="fas fa-share-nodes"></i> 分享畫面';
        }
    }

    window.onload = init;
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高鐵時刻表 - 網頁版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/zh-tw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* 保留你原始的 CSS 樣式 */
        :root {
            --primary: #ff6600;
            --bg-color: #f8f9fa;
            --text-dark: #2d3436;
            --border-color: #dfe6e9;
            --bubble-size: 42px;
            --tv-bg: #0f0f0f;
            --tv-header-north: #0056b3;
            --tv-header-south: #1e7e34;
            --tv-row-bg: #1a1a1a;
            --tv-text-white: #e0e0e0;
            --tv-text-yellow: #ffc107;
            --tv-dot-off: #444;
            --tv-line: #555;
            --tv-dot-north: #3498db;
            --tv-dot-south: #2ecc71;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-color); }

        .app-container { height: 100%; max-width: 600px; margin: 0 auto; background: white; display: flex; flex-direction: column; position: relative; }
        .app-header { padding: 15px; text-align: center; border-bottom: 1px solid var(--border-color); background: white; z-index: 10; }
        .app-header h1 { margin: 0; font-size: 1.2rem; color: var(--text-dark); display: flex; align-items: center; justify-content: center; gap: 8px; }
        
        .app-content { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 15px; scrollbar-width: none; }
        .app-content::-webkit-scrollbar { display: none; }
        .app-footer { padding: 15px; border-top: 1px solid var(--border-color); background: white; z-index: 10; }

        .section-title { font-size: 0.9rem; color: #636e72; margin-bottom: 8px; font-weight: 500; }
        .station-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .station-bubble { background: #f1f2f6; color: var(--text-dark); height: var(--bubble-size); display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 0.95rem; cursor: pointer; transition: 0.2s; user-select: none; border: 1px solid transparent; }
        .station-bubble.active { background: var(--primary); color: white; font-weight: bold; }
        
        .swap-wrapper { display: flex; justify-content: center; margin: -5px 0; position: relative; z-index: 5; }
        .swap-btn { background: white; border: 1px solid var(--border-color); color: var(--primary); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        
        input.flatpickr-input, select { 
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 10px; 
            background: #f8f9fa; font-size: 1rem; outline: none; color: #333;
        }

        .btn-submit { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 1.1rem; font-weight: 700; cursor: pointer; }
        .btn-submit:disabled { background: #ccc; }

        /* 彈窗樣式與電視牆樣式 (與原本相同) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; }
        .modal-active { display: flex; }
        .modal-card { background: white; width: 98%; max-width: 800px; border-radius: 12px; height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; background: white; }
        
        #view-list { flex: 1; overflow-y: auto; padding: 15px; }
        .result-card { border: 1px solid #eee; border-radius: 8px; margin-bottom: 15px; padding: 15px; background: white; }
        .train-id-pill { background: #fff5f0; color: var(--primary); padding: 4px 8px; border-radius: 6px; font-weight: bold; }
        .train-times { font-size: 1.2rem; font-weight: bold; }

        /* TV 牆特定樣式 */
        #view-tv { flex: 1; display: none; flex-direction: column; overflow: hidden; background: var(--tv-bg); }
        #view-tv.active { display: flex; }
        .tv-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .tv-header-bar { padding: 10px 15px; color: white; display: flex; justify-content: space-between; }
        .tv-header-bar.theme-north { background: var(--tv-header-north); }
        .tv-header-bar.theme-south { background: var(--tv-header-south); }
        .tv-scroll-area { flex: 1; overflow-y: auto; }
        .tv-row { display: grid; grid-template-columns: 260px 1fr; border-bottom: 1px solid #333; background: var(--tv-row-bg); }
        .tv-info-col { padding: 10px 15px; display: grid; grid-template-columns: 80px 100px 80px; align-items: center; }
        .tv-time { color: var(--tv-text-yellow); font-weight: bold; }
        .tv-map-col { position: relative; display: flex; align-items: center; padding: 10px; overflow-x: auto; }
        .map-container { display: flex; justify-content: space-between; width: 100%; min-width: 350px; position: relative; }
        .map-line { position: absolute; top: 75%; left: 0; right: 0; height: 2px; background: var(--tv-line); }
        .station-point { position: relative; z-index: 1; display: flex; flex-direction: column; align-items: center; width: 28px; }
        .st-name { font-size: 0.7rem; color: #888; writing-mode: vertical-rl; height: 40px; }
        .st-name.current { color: var(--tv-text-yellow); }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--tv-dot-off); margin-top: 5px; }
        .dot.stop { border: 1px solid #fff; }
        .theme-north .dot.stop { background: var(--tv-dot-north); }
        .theme-south .dot.stop { background: var(--tv-dot-south); }

        .toggle-btn { background: #eee; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
        .toggle-btn.active { background: var(--primary); color: white; }
        .share-btn { background: #00b894; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }

        @media (max-width: 600px) {
            .tv-row { grid-template-columns: 1fr; }
            .tv-info-col { border-bottom: 1px solid #333; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h1><i class="fas fa-train-subway" style="color:var(--primary)"></i> 高鐵時刻表</h1>
    </div>

    <div class="app-content">
        <div>
            <div class="section-title">出發站</div>
            <div class="station-grid" id="startGrid"></div>
        </div>

        <div class="swap-wrapper">
            <div class="swap-btn" onclick="swapStations()"><i class="fas fa-exchange-alt" style="transform: rotate(90deg);"></i></div>
        </div>

        <div>
            <div class="section-title">抵達站</div>
            <div class="station-grid" id="endGrid"></div>
        </div>

        <div style="display:flex; gap:10px;">
            <div style="flex:2; position:relative; display:flex; gap:5px;">
                <input type="text" id="query_time" placeholder="選擇時間">
                <button type="button" class="btn-submit" style="width:auto; padding:0 15px;" onclick="setCurrentTime()">現在</button>
            </div>
            <div style="flex:1">
                <select id="limit">
                    <option value="5">5筆</option>
                    <option value="10">10筆</option>
                    <option value="-1">全部</option>
                </select>
            </div>
        </div>
    </div>

    <div class="app-footer">
        <button id="searchBtn" class="btn-submit" onclick="fetchSchedule()">查詢班次</button>
    </div>
</div>

<div id="resultModal" class="modal-overlay">
    <div class="modal-card">
        <div class="modal-header">
            <div style="display:flex; gap:10px;">
                <button class="toggle-btn active" id="btn-list" onclick="switchView('list')">列表</button>
                <button class="toggle-btn" id="btn-tv" onclick="switchView('tv')">電視牆</button>
                <button class="share-btn" onclick="shareAsImage()">分享</button>
            </div>
            <button onclick="closeModal()" style="background:none; border:none; font-size:1.5rem;">&times;</button>
        </div>
        <div class="modal-body" id="capture-area">
            <div id="view-list"></div>
            <div id="view-tv">
                <div class="tv-wrapper">
                    <div id="tv-header" class="tv-header-bar"></div>
                    <div id="tv-rows" class="tv-scroll-area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://superiorapis-creator.cteam.com.tw/manager/feature/proxy/9521ab51a9e8/pub_9521b06baee0";
    const TOKEN = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJjZXJ0IjoiOTczOTIyYjg1OTkxZTE3ZDUyZGU0MDE1ZmIzNjU5ZmIzM2M4ODkzOSIsImlhdCI6MTc2Njk4ODQ2OX0.G9SVSfeuon2Rf7iSLmKfzEAXLK_DVz3ZsPQeB1xzSRc";
    
    const stations = {
        1: "南港", 2: "台北", 3: "板橋", 4: "桃園", 5: "新竹", 6: "苗栗",
        7: "台中", 8: "彰化", 9: "雲林", 10: "嘉義", 11: "台南", 12: "左營"
    };

    let currentStart = 0;
    let currentEnd = 0;
    let flatpickrInstance;

    // 初始化介面
    function init() {
        const createGrid = (containerId, type) => {
            const container = document.getElementById(containerId);
            Object.entries(stations).forEach(([id, name]) => {
                const div = document.createElement('div');
                div.className = 'station-bubble';
                div.textContent = name;
                div.dataset.id = id;
                div.onclick = () => selectStation(type, parseInt(id));
                container.appendChild(div);
            });
        };
        createGrid('startGrid', 'start');
        createGrid('endGrid', 'end');

        flatpickrInstance = flatpickr("#query_time", {
            enableTime: true,
            dateFormat: "Y-m-d H:i",
            locale: "zh_tw",
            defaultDate: new Date(),
            time_24hr: true
        });
    }

    function selectStation(type, id) {
        if (type === 'start') {
            currentStart = id;
            if (currentEnd === id) currentEnd = 0;
        } else {
            currentEnd = id;
            if (currentStart === id) currentStart = 0;
        }
        updateVisuals();
    }

    function updateVisuals() {
        document.querySelectorAll('#startGrid .station-bubble').forEach(el => 
            el.classList.toggle('active', parseInt(el.dataset.id) === currentStart));
        document.querySelectorAll('#endGrid .station-bubble').forEach(el => 
            el.classList.toggle('active', parseInt(el.dataset.id) === currentEnd));
    }

    function swapStations() {
        [currentStart, currentEnd] = [currentEnd, currentStart];
        updateVisuals();
    }

    function setCurrentTime() { flatpickrInstance.setDate(new Date()); }

    // 調用 API
    async function fetchSchedule() {
        if (!currentStart || !currentEnd) return alert("請選擇起訖站");
        if (currentStart === currentEnd) return alert("起迄站不能相同");

        const btn = document.getElementById('searchBtn');
        btn.disabled = true;
        btn.textContent = "查詢中...";

        try {
            const queryTime = document.getElementById('query_time').value;
            const isoTime = new Date(queryTime).toISOString();
            
            const response = await axios.post(API_URL, {
                start_station_no: currentStart,
                end_station_no: currentEnd,
                datetime: isoTime
            }, {
                headers: { 'token': TOKEN, 'Content-Type': 'application/json' }
            });

            renderResults(response.data);
            document.getElementById('resultModal').classList.add('modal-active');
        } catch (error) {
            alert("查詢失敗：" + (error.response?.data?.message || error.message));
        } finally {
            btn.disabled = false;
            btn.textContent = "查詢班次";
        }
    }

    function renderResults(data) {
        const trains = data.train_item || data.data || [];
        const listContainer = document.getElementById('view-list');
        const tvRows = document.getElementById('tv-rows');
        const tvHeader = document.getElementById('tv-header');
        const limit = parseInt(document.getElementById('limit').value);
        
        listContainer.innerHTML = '';
        tvRows.innerHTML = '';

        const isSouth = currentStart < currentEnd;
        const themeClass = isSouth ? "theme-south" : "theme-north";
        tvHeader.className = `tv-header-bar ${themeClass}`;
        tvHeader.innerHTML = `<span>${isSouth ? '南下 Southbound' : '北上 Northbound'}</span><span>${new Date().toLocaleTimeString()} UPDATED</span>`;

        // 排序車站 (TV 牆用)
        const sortedStationKeys = Object.keys(stations).map(Number);
        if (!isSouth) sortedStationKeys.sort((a, b) => b - a);

        let count = 0;
        trains.forEach(train => {
            if (limit !== -1 && count >= limit) return;
            count++;

            // 停靠站處理
            const stopIds = (train.station_info || []).map(s => parseInt(s.station_no));
            const stopNames = (train.station_info || [])
                .filter(s => {
                    const sid = parseInt(s.station_no);
                    return isSouth ? (sid > currentStart && sid < currentEnd) : (sid < currentStart && sid > currentEnd);
                })
                .map(s => s.name);

            const stopsStr = stopNames.length ? stopNames.join(' <i class="fas fa-caret-right"></i> ') : "直達";

            // 1. 渲染列表視圖
            listContainer.innerHTML += `
                <div class="result-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <span class="train-id-pill">${train.id || train.train_no}</span>
                            <small style="color:#888; margin-left:10px;">${train.duration || ''}</small>
                        </div>
                        <div class="train-times">${train.departure_time} ➝ ${train.destination_time || train.arrival_time}</div>
                    </div>
                    <div style="margin-top:10px; font-size:0.9rem; color:#666; border-top:1px dashed #eee; padding-top:8px;">
                        <span style="background:#eee; padding:2px 6px; border-radius:4px; margin-right:8px;">停靠</span> ${stopsStr}
                    </div>
                </div>`;

            // 2. 渲染 TV 視圖
            let mapHtml = '';
            sortedStationKeys.forEach(sid => {
                const isStop = stopIds.includes(sid) || sid === currentStart || sid === currentEnd;
                mapHtml += `
                    <div class="station-point">
                        <div class="st-name ${sid === currentStart ? 'current' : ''}">${stations[sid].substring(0,2)}</div>
                        <div class="dot ${isStop ? 'stop' : ''}"></div>
                    </div>`;
            });

            tvRows.innerHTML += `
                <div class="tv-row">
                    <div class="tv-info-col">
                        <div style="color:white; font-size:1.2rem;">${train.id || train.train_no}</div>
                        <div style="color:white;">${stations[currentEnd]}</div>
                        <div class="tv-time">${train.departure_time}</div>
                    </div>
                    <div class="tv-map-col ${themeClass}">
                        <div class="map-container">
                            <div class="map-line"></div>
                            ${mapHtml}
                        </div>
                    </div>
                </div>`;
        });
    }

    function switchView(mode) {
        document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-' + mode).classList.add('active');
        document.getElementById('view-list').style.display = mode === 'list' ? 'block' : 'none';
        document.getElementById('view-tv').classList.toggle('active', mode === 'tv');
        document.getElementById('capture-area').style.background = mode === 'tv' ? '#0f0f0f' : 'white';
    }

    function closeModal() { document.getElementById('resultModal').classList.remove('modal-active'); }

    async function shareAsImage() {
        const area = document.getElementById('capture-area');
        const canvas = await html2canvas(area, { backgroundColor: getComputedStyle(area).backgroundColor, scale: 2 });
        const link = document.createElement('a');
        link.download = 'thsr.png';
        link.href = canvas.toDataURL();
        link.click();
    }

    window.onload = init;
</script>
</body>
</html>
